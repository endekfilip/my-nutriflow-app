<div class="home-container">
  
  <div class="hero-section">
    <h1 class="hero-title">Welcome to NutriFlow</h1>
    <p class="hero-subtitle">Your personal dashboard for a healthier lifestyle</p>
  </div>

  <div *ngIf="!isBrowser || isLoading" class="text-center mt-5" style="padding: 50px;">
    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading your flow...</p>
  </div>

  <div *ngIf="isBrowser && !isLoading && !isLoggedIn" class="text-center mt-5">
    <div class="feature-card mx-auto" style="max-width: 600px; padding: 40px;">
      <i class="fa-solid fa-lock" style="font-size: 3rem; color: #f39c12; margin-bottom: 20px;"></i>
      <h2 style="color: #2c3e50;">Login Required</h2>
      <p class="text-muted" style="font-size: 1.1rem; margin: 20px 0;">
        To track your personal BMI, Daily Intake history, and save your progress, please log in to your account.
      </p>
      <div class="d-flex gap-3 justify-content-center">
        <button class="btn-action btn-green" routerLink="/login" style="width: auto; padding: 10px 30px;">Login</button>
        <button class="btn-action btn-blue" routerLink="/register" style="width: auto; padding: 10px 30px;">Register</button>
      </div>
    </div>
  </div>

  <div class="dashboard-grid" *ngIf="isBrowser && !isLoading && isLoggedIn">

    <div class="feature-card">
      <h3 class="card-title">‚öñÔ∏è BMI Calculator</h3>
      <div class="input-group">
        <label>Height (cm)</label>
        <input type="number" [(ngModel)]="bmiHeight" class="form-control" placeholder="e.g. 180">
      </div>
      <div class="input-group">
        <label>Weight (kg)</label>
        <input type="number" [(ngModel)]="bmiWeight" class="form-control" placeholder="e.g. 75">
      </div>
      <button class="btn-action btn-green" (click)="calculateBMI()">Calculate BMI</button>
      <div class="mt-4 text-center">
        <h5>Your BMI Is: <span style="color: #2ecc71; font-weight: bold;">{{ bmiResult }}</span></h5>
        <small>Classification: <span style="font-weight: bold;">{{ bmiClass }}</span></small>
      </div>
    </div>

    <div class="feature-card" style="border-top: 4px solid #3498db;">
      <h3 class="card-title" style="color: #3498db;">üçΩÔ∏è Quick Log</h3>
      
      <div class="mb-3">
        <label class="d-block text-center text-muted small fw-bold mb-2">Food Item</label>
        <input 
          type="text" 
          [(ngModel)]="quickFoodName" 
          class="form-control text-center" 
          placeholder="Search food above to begin..." 
          style="font-style: italic;">
      </div>

      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <div style="flex: 1;">
          <label class="text-center d-block" style="font-size: 0.9rem; color: #666;">Kcal/100g</label>
          <input type="number" [(ngModel)]="quickCaloriesPer100g" class="form-control text-center">
        </div>
        <div style="flex: 1;">
          <label class="text-center d-block" style="font-size: 0.9rem; color: #666;">Portion (g)</label>
          <input type="number" [(ngModel)]="quickGrams" class="form-control text-center">
        </div>
      </div>

      <div class="text-center mb-3 p-2" 
           style="background-color: #f0f8ff; border-radius: 8px; color: #2c3e50;" 
           *ngIf="quickCaloriesPer100g > 0">
         <span style="font-size: 0.9rem;">Total:</span> 
         <strong style="font-size: 1.2rem; color: #3498db;">{{ calculatedCalories }}</strong> cal
      </div>

      <button class="btn-action" 
              style="background-color: #3498db; width: 100%;" 
              [disabled]="!quickFoodName || quickGrams <= 0" 
              (click)="addQuickFood()">
        Add to Log
      </button>
    </div>

    <div class="feature-card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title" style="margin: 0;">üçé Daily Intake</h3>
        <span class="badge" [ngClass]="{'badge-online': isOnline, 'badge-offline': !isOnline}">
          DB: {{ dbStatus }}
        </span>
      </div>
      <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
      <div class="stats-container">
        <p>Total Calories Consumed:</p>
        <h1 class="big-number">{{ totalCalories }} <small>cal</small></h1>
        <div style="width: 80%; margin: 10px auto;">
          <div class="progress" style="height: 25px; border-radius: 15px; background-color: #e9ecef;">
            <div 
              class="progress-bar progress-bar-striped progress-bar-animated" 
              role="progressbar" 
              [ngClass]="progressColor"
              [style.width.%]="progressPercent > 100 ? 100 : progressPercent"
              aria-valuemin="0" 
              aria-valuemax="2500">
              {{ progressPercent | number:'1.0-0' }}%
            </div>
          </div>
          <small class="text-muted">Goal: {{ calorieGoal }} cal</small>
        </div>
      </div>
      <p class="text-muted text-center" *ngIf="isOnline">Data fetched live from MongoDB.</p>
      <div class="button-row">
        <button class="btn-action btn-blue" (click)="checkDatabase()">Refresh</button>
        <button class="btn-action" style="background-color: #f39c12;" (click)="openHistory()">View Log</button>
        <button class="btn-action btn-red" (click)="clearLog()">Clear</button>
      </div>
    </div>

  </div>
</div>

<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-content">
    <span class="close-btn" (click)="closeHistory()">&times;</span>
    <h3>üçΩÔ∏è Food History</h3>
    
    <ul class="history-list">
      <li class="history-item" *ngFor="let item of historyList" 
          style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
        
        <div>
           <span style="font-weight: bold; color: #2c3e50;">{{ item.name || 'Unknown' }}</span>
           <span class="text-muted small ms-2">({{ item.grams }}g)</span>
        </div>

        <div style="display: flex; align-items: center; gap: 10px;">
           <span class="badge bg-success rounded-pill">+{{ item.totalCalories | number:'1.0-0' }} cal</span>
           
           <button class="btn btn-sm btn-outline-danger border-0" 
                   (click)="deleteItem(item._id)" 
                   title="Delete Item"
                   style="background: transparent;">
             üóëÔ∏è
           </button>
        </div>

      </li>
    </ul>

    <div *ngIf="historyList.length === 0" class="mt-3 text-muted text-center">No food logged yet.</div>
    <button class="btn-action btn-blue mt-3" (click)="closeHistory()">Close</button>
  </div>
</div>